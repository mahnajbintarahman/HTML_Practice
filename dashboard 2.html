<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Dashboard - Custom Parameters</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b0b0b; --panel: #161616; --card: #1c1c1c;
            --text: #ffffff; --danger: #ff4d4d; --safe: #00ff88;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        .main-container {
            background: var(--panel); padding: 30px; border-radius: 20px;
            display: grid; grid-template-columns: 500px 420px; gap: 20px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6); border: 1px solid #333;
        }

        .gas-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .gauge-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #333; transition: 0.3s; }
        .alarm-active { border-color: var(--danger) !important; background: #3d0a0a !important; }
        .gauge-canvas { width: 150px; height: 90px; }
        
        /* Updated Camera Window */
        .camera-window { 
            width: 100%; height: 230px; background: #000; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid #222; overflow: hidden; position: relative;
        }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }

        .settings-panel {
            grid-column: span 2; background: #111; padding: 20px; border-radius: 12px;
            border: 1px dashed #444; margin-top: 15px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
        }
        .settings-panel div { display: flex; flex-direction: column; font-size: 0.8rem; }
        input { background: #222; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; margin-top: 5px; }

        .chart-section { grid-column: span 2; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #333; margin-top: 10px; height: 200px; }
        
        button { padding: 10px; color: white; border-radius: 5px; cursor: pointer; border: 1px solid #444; background: #333; transition: 0.3s; }
        button:hover { background: #444; }
        .btn-connect { background: #2563eb; border-color: #3b82f6; }
        .btn-disconnect { background: #991b1b; border-color: #ef4444; }
    </style>
</head>
<body onload="initSystem()">

<div class="main-container">
    <div class="gas-section">
        <h3 style="grid-column: span 2; margin:0; color:#888;">GAS MONITORING</h3>
        <div id="card-c1" class="gauge-card"><canvas id="c1" class="gauge-canvas"></canvas><span id="label-c1">CO</span></div>
        <div id="card-c2" class="gauge-card"><canvas id="c2" class="gauge-canvas"></canvas><span id="label-c2">O2</span></div>
        <div id="card-c3" class="gauge-card"><canvas id="c3" class="gauge-canvas"></canvas><span id="label-c3">CH4</span></div>
        <div id="card-c4" class="gauge-card"><canvas id="c4" class="gauge-canvas"></canvas><span id="label-c4">CO2</span></div>
    </div>

    <div class="right-panel">
        <div class="camera-window" id="camContainer">
            <video id="webcam" autoplay playsinline></video>
            <span id="camPlaceholder" style="color:#444; font-weight: bold;">CAMERA OFFLINE</span>
        </div>
        <div class="gauge-card" style="margin-top:15px">
            <h4 style="margin:0 0 10px 0; color:#888">SYSTEM CONTROLS</h4>
            <div style="display: flex; flex-direction: column; gap: 10px; justify-content: center;">
                <button id="camBtn" class="btn-connect" onclick="toggleCamera()">CONNECT CAM</button>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button style="flex: 1;" onclick="this.style.background = this.style.background === 'blue' ? '#333' : 'blue'">FAN 1</button>
                    <button style="flex: 1;" onclick="this.style.background = this.style.background === 'blue' ? '#333' : 'blue'">FAN 2</button>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-panel">
        <h4 style="grid-column: span 5; margin:0 0 10px 0; color:var(--safe)">SET DANGER THRESHOLDS</h4>
        <div><label>CO Danger</label><input type="number" id="thresh-c1" value="50" title="CO danger threshold in PPM"></div>
        <div><label>O2 Danger</label><input type="number" id="thresh-c2" value="19" title="O2 danger threshold in %"></div>
        <div><label>CH4 Danger</label><input type="number" id="thresh-c3" value="10" title="CH4 danger threshold in PPM"></div>
        <div><label>CO2 Danger</label><input type="number" id="thresh-c4" value="1000" title="CO2 danger threshold in PPM"></div>
        <div style="color:#666; font-style:italic">Values in PPM/%</div>
    </div>

    <div class="chart-section">
        <canvas id="historyChart"></canvas>
    </div>
</div>

<script>
    let chart;
    let streamInstance = null;
    const gasData = { c1: 0, c2: 21, c3: 0, c4: 400 };

    function initSystem() {
        initChart();
        setInterval(updateData, 2000);
    }

    // New Camera Toggle Function
    async function toggleCamera() {
        const video = document.getElementById('webcam');
        const placeholder = document.getElementById('camPlaceholder');
        const btn = document.getElementById('camBtn');

        if (streamInstance) {
            // Stop all tracks to fully disconnect
            streamInstance.getTracks().forEach(track => track.stop());
            streamInstance = null;
            video.srcObject = null;
            video.style.display = "none";
            placeholder.style.display = "block";
            btn.innerText = "CONNECT CAM";
            btn.className = "btn-connect";
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                streamInstance = stream;
                video.srcObject = stream;
                video.style.display = "block";
                placeholder.style.display = "none";
                btn.innerText = "DISCONNECT";
                btn.className = "btn-disconnect";
            } catch (err) {
                alert("Could not access camera. Check permissions.");
            }
        }
    }

    function initChart() {
        const ctx = document.getElementById('historyChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Main Gas Stream', borderColor: '#00ff88', data: [], tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { display: false } } }
        });
    }

    function drawGauge(id, val) {
        const can = document.getElementById(id);
        const ctx = can.getContext('2d');
        const threshold = parseFloat(document.getElementById('thresh-' + id).value);
        const isDanger = val >= threshold;

        document.getElementById('card-' + id).classList.toggle('alarm-active', isDanger);

        ctx.clearRect(0,0,can.width,can.height);
        const x = can.width/2, y = can.height - 10, rad = 65;

        ctx.beginPath(); ctx.arc(x,y,rad,Math.PI,0);
        ctx.lineWidth = 12; ctx.strokeStyle = '#252525'; ctx.stroke();

        const maxScale = threshold * 1.5 || 100;
        const fillAngle = Math.min(val / maxScale, 1);

        ctx.beginPath(); ctx.arc(x,y,rad,Math.PI, Math.PI + (Math.PI * fillAngle));
        ctx.strokeStyle = isDanger ? '#ff4d4d' : '#00ff88'; ctx.stroke();
        
        ctx.fillStyle = "white";
        ctx.fillText(val.toFixed(1), x - 10, y - 20);
    }

    function updateData() {
        gasData.c1 = Math.random() * 80; 
        gasData.c2 = 18 + Math.random() * 5;
        gasData.c3 = Math.random() * 15;
        gasData.c4 = 350 + Math.random() * 800;

        drawGauge('c1', gasData.c1);
        drawGauge('c2', gasData.c2);
        drawGauge('c3', gasData.c3);
        drawGauge('c4', gasData.c4);

        chart.data.labels.push("");
        chart.data.datasets[0].data.push(gasData.c1);
        if(chart.data.labels.length > 20) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
        chart.update('none');
    }
</script>
</body>
</html>